<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Digital Twin Platform</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #2196F3;
        --primary-dark: #1976D2;
        --accent: #87ceeb;
        --bg-dark: #0a0a14;
        --bg-card: #12121f;
        --bg-card-hover: #1a1a2e;
        --text: #ffffff;
        --text-muted: #888;
        --border: rgba(255, 255, 255, 0.1);
        --success: #4CAF50;
        --warning: #FF9800;
        --error: #f44336;
      }

      html, body {
        width: 100%;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-dark);
        color: var(--text);
        overflow-x: hidden;
      }

      /* Header */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        border-bottom: 1px solid var(--border);
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 20px;
        font-weight: 600;
        color: var(--accent);
      }

      .logo-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .logo-icon svg {
        width: 20px;
        height: 20px;
        color: white;
      }

      .header-actions {
        display: flex;
        gap: 15px;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
      }

      .btn-secondary {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover {
        background: var(--bg-card);
        color: var(--text);
        border-color: var(--text-muted);
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
      }

      .btn-primary:disabled {
        background: #555;
        cursor: not-allowed;
      }

      /* Main Content */
      .main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 60px 40px;
      }

      .page-title {
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .page-subtitle {
        color: var(--text-muted);
        font-size: 16px;
        margin-bottom: 40px;
      }

      /* Twin Grid */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 500;
        color: var(--text-muted);
      }

      .twins-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 60px;
      }

      /* Twin Card */
      .twin-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s;
      }

      .twin-card.clickable {
        cursor: pointer;
      }

      .twin-card.clickable:hover {
        background: var(--bg-card-hover);
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 10px 40px rgba(33, 150, 243, 0.15);
      }

      .twin-card.completed {
        border-color: var(--success);
      }

      .twin-preview {
        height: 160px;
        background: linear-gradient(135deg, #1a1a2e 0%, #2a2a4e 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .twin-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .twin-preview-placeholder {
        color: var(--text-muted);
        font-size: 48px;
      }

      .twin-status {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
      }

      .twin-status.completed {
        background: rgba(76, 175, 80, 0.2);
        color: #81c784;
        border: 1px solid rgba(76, 175, 80, 0.3);
      }

      .twin-status.running {
        background: rgba(33, 150, 243, 0.2);
        color: #64b5f6;
        border: 1px solid rgba(33, 150, 243, 0.3);
      }

      .twin-status.pending {
        background: rgba(255, 152, 0, 0.2);
        color: #ffb74d;
        border: 1px solid rgba(255, 152, 0, 0.3);
      }

      .twin-status.failed {
        background: rgba(244, 67, 54, 0.2);
        color: #e57373;
        border: 1px solid rgba(244, 67, 54, 0.3);
      }

      .twin-status.awaiting_lidar {
        background: rgba(156, 39, 176, 0.2);
        color: #ce93d8;
        border: 1px solid rgba(156, 39, 176, 0.3);
      }

      /* LiDAR awaiting card styles */
      .twin-lidar-info {
        padding: 15px 20px;
        background: rgba(156, 39, 176, 0.1);
        border-top: 1px solid var(--border);
      }

      .lidar-tiles {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 10px;
      }

      .lidar-tiles strong {
        color: var(--text);
      }

      .lidar-tile-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
      }

      .lidar-tile {
        background: var(--bg-dark);
        padding: 4px 8px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        color: #ce93d8;
      }

      .lidar-instructions {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 12px;
        line-height: 1.5;
      }

      .lidar-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .btn-lidar {
        background: #9c27b0;
        color: white;
      }

      .btn-lidar:hover {
        background: #7b1fa2;
      }

      .twin-info {
        padding: 20px;
      }

      .twin-name {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .twin-location {
        color: var(--text-muted);
        font-size: 14px;
        margin-bottom: 12px;
      }

      .twin-stats {
        display: flex;
        gap: 20px;
        font-size: 13px;
        color: var(--text-muted);
      }

      .twin-stat {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .twin-stat svg {
        width: 14px;
        height: 14px;
        opacity: 0.7;
      }

      /* Progress bar */
      .twin-progress {
        padding: 0 20px 20px;
      }

      .progress-bar {
        height: 6px;
        background: var(--border);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 3px;
        transition: width 0.3s;
      }

      .progress-text {
        font-size: 12px;
        color: var(--text-muted);
      }

      .twin-error {
        padding: 0 20px 20px;
        color: var(--error);
        font-size: 13px;
      }

      .twin-actions {
        padding: 0 20px 20px;
        display: flex;
        gap: 10px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
      }

      /* Create New Card */
      .twin-card.create-new {
        border-style: dashed;
        border-color: var(--text-muted);
        opacity: 0.7;
        cursor: pointer;
      }

      .twin-card.create-new:hover {
        opacity: 1;
        border-color: var(--primary);
        background: rgba(33, 150, 243, 0.05);
      }

      .create-content {
        height: 100%;
        min-height: 280px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 15px;
        padding: 40px;
      }

      .create-icon {
        width: 60px;
        height: 60px;
        border: 2px solid var(--text-muted);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        color: var(--text-muted);
        transition: all 0.2s;
      }

      .twin-card.create-new:hover .create-icon {
        border-color: var(--primary);
        color: var(--primary);
      }

      .create-text {
        font-size: 16px;
        font-weight: 500;
      }

      .create-hint {
        color: var(--text-muted);
        font-size: 13px;
        text-align: center;
      }

      /* Features Section */
      .features {
        margin-top: 40px;
        padding-top: 40px;
        border-top: 1px solid var(--border);
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 30px;
        margin-top: 30px;
      }

      .feature {
        display: flex;
        gap: 15px;
      }

      .feature-icon {
        width: 40px;
        height: 40px;
        background: rgba(33, 150, 243, 0.1);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .feature-icon svg {
        width: 20px;
        height: 20px;
        color: var(--primary);
      }

      .feature-title {
        font-size: 15px;
        font-weight: 500;
        margin-bottom: 4px;
      }

      .feature-desc {
        font-size: 13px;
        color: var(--text-muted);
        line-height: 1.5;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        transform: translateY(20px);
        transition: transform 0.3s;
      }

      .modal-overlay.active .modal {
        transform: translateY(0);
      }

      .modal-header {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }

      .modal-close:hover {
        color: var(--text);
      }

      .modal-body {
        padding: 25px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .form-input, .form-select {
        width: 100%;
        padding: 12px 15px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .form-input:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary);
      }

      .form-input::placeholder {
        color: #555;
      }

      .form-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 6px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      /* Map */
      #aoi-map {
        height: 300px;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-bottom: 10px;
      }

      .map-hint {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .coordinates-display {
        font-size: 13px;
        color: var(--accent);
        margin-top: 8px;
      }

      .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      /* Loading state */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 40px;
        color: var(--text-muted);
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header {
          padding: 15px 20px;
        }

        .main {
          padding: 30px 20px;
        }

        .page-title {
          font-size: 24px;
        }

        .twins-grid {
          grid-template-columns: 1fr;
        }

        .features-grid {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
            <path d="M2 17l10 5 10-5"/>
            <path d="M2 12l10 5 10-5"/>
          </svg>
        </div>
        <span>Digital Twin Platform</span>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary">Documentation</button>
        <button class="btn btn-secondary">Settings</button>
      </div>
    </header>

    <main class="main">
      <h1 class="page-title">Your Digital Twins</h1>
      <p class="page-subtitle">Create, manage, and explore interactive 3D models of real-world locations</p>

      <div class="twins-grid" id="twins-grid">
        <div class="loading">
          <div class="spinner"></div>
          <span>Loading twins...</span>
        </div>
      </div>

      <!-- Features -->
      <section class="features">
        <h2 class="section-title">Platform Features</h2>
        <div class="features-grid">
          <div class="feature">
            <div class="feature-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                <polyline points="2 17 12 22 22 17"/>
                <polyline points="2 12 12 17 22 12"/>
              </svg>
            </div>
            <div>
              <h4 class="feature-title">3D Visualization</h4>
              <p class="feature-desc">Interactive WebGL viewer with satellite imagery, terrain, and procedurally generated buildings</p>
            </div>
          </div>
          <div class="feature">
            <div class="feature-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </div>
            <div>
              <h4 class="feature-title">Custom Mesh Editor</h4>
              <p class="feature-desc">Edit building geometry, materials, and textures directly in the browser</p>
            </div>
          </div>
          <div class="feature">
            <div class="feature-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
              </svg>
            </div>
            <div>
              <h4 class="feature-title">Data Integration</h4>
              <p class="feature-desc">Combine OSM data, LiDAR heights, geocoded addresses, and user overrides</p>
            </div>
          </div>
          <div class="feature">
            <div class="feature-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                <line x1="8" y1="21" x2="16" y2="21"/>
                <line x1="12" y1="17" x2="12" y2="21"/>
              </svg>
            </div>
            <div>
              <h4 class="feature-title">API Access</h4>
              <p class="feature-desc">REST API for building data, property overrides, and custom mesh management</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Regenerate Modal -->
    <div class="modal-overlay" id="regenerateModal">
      <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
          <h3 class="modal-title">Regenerate Twin</h3>
          <button class="modal-close" onclick="closeRegenerateModal()">&times;</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 20px; color: var(--text-muted);">
            This will re-run the pipeline from scratch. Existing LiDAR tiles will be preserved.
          </p>
          <div class="form-group">
            <label class="form-label">Area Size</label>
            <select class="form-select" id="regen-size">
              <option value="1000">1 km x 1 km</option>
              <option value="2000">2 km x 2 km</option>
              <option value="3000">3 km x 3 km</option>
              <option value="5000">5 km x 5 km</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Buffer (for rasters)</label>
            <select class="form-select" id="regen-buffer">
              <option value="250">250 m</option>
              <option value="500">500 m</option>
              <option value="1000">1000 m</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="regen-use-lidar" style="width: 18px; height: 18px; accent-color: var(--primary);">
              <span>Use LiDAR terrain data (England only)</span>
            </label>
            <p class="form-hint">
              When enabled, you may need to download LiDAR tiles from the EA portal.
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeRegenerateModal()">Cancel</button>
          <button class="btn btn-primary" id="regen-btn" onclick="confirmRegenerate()">Regenerate</button>
        </div>
      </div>
    </div>

    <!-- Create Modal -->
    <div class="modal-overlay" id="createModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Create New Digital Twin</h3>
          <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Project Name *</label>
            <input type="text" class="form-input" id="twin-name" placeholder="e.g., Newcastle City Centre">
          </div>
          <div class="form-group">
            <label class="form-label">Location Description</label>
            <input type="text" class="form-input" id="twin-location" placeholder="e.g., Tyne and Wear, England">
          </div>
          <div class="form-group">
            <label class="form-label">Select Area of Interest</label>
            <div id="aoi-map"></div>
            <p class="map-hint">Click on the map to set the centre point. The rectangle shows the selected area.</p>
            <div class="coordinates-display" id="coords-display">Centre: Click map to select</div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Area Size</label>
              <select class="form-select" id="twin-size">
                <option value="1000">1 km x 1 km</option>
                <option value="2000" selected>2 km x 2 km</option>
                <option value="3000">3 km x 3 km</option>
                <option value="5000">5 km x 5 km</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Buffer (for rasters)</label>
              <select class="form-select" id="twin-buffer">
                <option value="250">250 m</option>
                <option value="500" selected>500 m</option>
                <option value="1000">1000 m</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="twin-use-lidar" checked style="width: 18px; height: 18px; accent-color: var(--primary);">
              <span>Use LiDAR terrain data (England only)</span>
            </label>
            <p class="form-hint">
              When enabled, you may need to download LiDAR tiles from the EA portal.
              Disable for faster processing using OSM building heights only.
            </p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
          <button class="btn btn-primary" id="create-btn" onclick="createTwin()">Create Twin</button>
        </div>
      </div>
    </div>

    <script>
      // State
      let twins = [];
      let map = null;
      let marker = null;
      let rectangle = null;
      let selectedLat = null;
      let selectedLon = null;
      const activeSSE = {};

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        loadTwins();
      });

      // API Functions
      async function loadTwins() {
        try {
          const res = await fetch('/api/twins');
          const data = await res.json();
          twins = data.twins || [];
          renderTwins();
        } catch (err) {
          console.error('Failed to load twins:', err);
          // Show static Blyth twin as fallback
          twins = [];
          renderTwins();
        }
      }

      async function createTwin() {
        const name = document.getElementById('twin-name').value.trim();
        const location = document.getElementById('twin-location').value.trim();
        const size = parseInt(document.getElementById('twin-size').value);
        const buffer = parseInt(document.getElementById('twin-buffer').value);
        const useLidar = document.getElementById('twin-use-lidar').checked;

        if (!name) {
          alert('Please enter a project name');
          return;
        }

        if (!selectedLat || !selectedLon) {
          alert('Please select a location on the map');
          return;
        }

        const btn = document.getElementById('create-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';

        try {
          const res = await fetch('/api/twins', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name,
              location_name: location || null,
              centre_lat: selectedLat,
              centre_lon: selectedLon,
              side_length_m: size,
              buffer_m: buffer,
              use_lidar: useLidar
            })
          });

          if (!res.ok) {
            throw new Error('Failed to create twin');
          }

          const data = await res.json();
          closeCreateModal();
          loadTwins();

          // Subscribe to progress
          subscribeToProgress(data.id);

        } catch (err) {
          console.error('Failed to create twin:', err);
          alert('Failed to create twin. Please check the API is running.');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Create Twin';
        }
      }

      async function deleteTwin(id, e) {
        e.stopPropagation();
        if (!confirm('Are you sure you want to delete this twin?')) return;

        try {
          await fetch(`/api/twins/${id}`, { method: 'DELETE' });
          loadTwins();
        } catch (err) {
          console.error('Failed to delete twin:', err);
        }
      }

      async function retryTwin(id, e) {
        e.stopPropagation();
        try {
          await fetch(`/api/twins/${id}/retry`, { method: 'POST' });
          loadTwins();
          subscribeToProgress(id);
        } catch (err) {
          console.error('Failed to retry twin:', err);
        }
      }

      let regeneratingTwinId = null;

      async function regenerateTwin(id, e) {
        e.stopPropagation();
        regeneratingTwinId = id;

        // Fetch current twin settings
        try {
          const res = await fetch(`/api/twins/${id}`);
          const twin = await res.json();

          // Pre-fill modal with current values
          document.getElementById('regen-size').value = twin.side_length_m;
          document.getElementById('regen-buffer').value = twin.buffer_m;
          document.getElementById('regen-use-lidar').checked = twin.has_lidar || false;

          // Open modal
          document.getElementById('regenerateModal').classList.add('active');
        } catch (err) {
          console.error('Failed to load twin:', err);
          alert('Failed to load twin settings');
        }
      }

      function closeRegenerateModal() {
        document.getElementById('regenerateModal').classList.remove('active');
        regeneratingTwinId = null;
      }

      async function confirmRegenerate() {
        if (!regeneratingTwinId) return;

        const size = parseInt(document.getElementById('regen-size').value);
        const buffer = parseInt(document.getElementById('regen-buffer').value);
        const useLidar = document.getElementById('regen-use-lidar').checked;

        const btn = document.getElementById('regen-btn');
        btn.disabled = true;
        btn.textContent = 'Starting...';

        try {
          const res = await fetch(`/api/twins/${regeneratingTwinId}/regenerate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              side_length_m: size,
              buffer_m: buffer,
              use_lidar: useLidar
            })
          });

          if (!res.ok) {
            const data = await res.json();
            alert(data.detail || 'Failed to regenerate twin');
            btn.disabled = false;
            btn.textContent = 'Regenerate';
            return;
          }

          closeRegenerateModal();
          loadTwins();
          subscribeToProgress(regeneratingTwinId);
        } catch (err) {
          console.error('Failed to regenerate twin:', err);
          alert('Failed to regenerate twin. Please check the API is running.');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Regenerate';
        }
      }

      async function continueTwin(id, e) {
        e.stopPropagation();
        const btn = e.target;
        btn.disabled = true;
        btn.textContent = 'Checking tiles...';

        try {
          const res = await fetch(`/api/twins/${id}/continue`, { method: 'POST' });
          if (!res.ok) {
            const data = await res.json();
            alert(data.detail || 'Failed to continue. Please ensure all tiles are uploaded.');
            btn.disabled = false;
            btn.textContent = "I've uploaded tiles - Continue";
            return;
          }
          loadTwins();
          subscribeToProgress(id);
        } catch (err) {
          console.error('Failed to continue twin:', err);
          alert('Failed to continue. Please check the API is running.');
          btn.disabled = false;
          btn.textContent = "I've uploaded tiles - Continue";
        }
      }

      async function skipLidar(id, e) {
        e.stopPropagation();
        if (!confirm('Skip LiDAR data? Buildings will use flat terrain (elevation 0).')) return;

        const btn = e.target;
        btn.disabled = true;
        btn.textContent = 'Skipping...';

        try {
          const res = await fetch(`/api/twins/${id}/skip-lidar`, { method: 'POST' });
          if (!res.ok) {
            throw new Error('Failed to skip LiDAR');
          }
          loadTwins();
          subscribeToProgress(id);
        } catch (err) {
          console.error('Failed to skip LiDAR:', err);
          alert('Failed to skip LiDAR. Please check the API is running.');
          btn.disabled = false;
          btn.textContent = 'Skip LiDAR (flat terrain)';
        }
      }

      async function loadLidarTiles(twinId) {
        try {
          const res = await fetch(`/api/twins/${twinId}/lidar-tiles`);
          const data = await res.json();

          const container = document.getElementById(`lidar-tiles-${twinId}`);
          if (!container) return;

          if (data.tiles_needed && data.tiles_needed.length > 0) {
            container.innerHTML = data.tiles_needed
              .map(tile => `<span class="lidar-tile">${tile}</span>`)
              .join('');
          } else {
            container.innerHTML = '<span>No tiles needed</span>';
          }
        } catch (err) {
          console.error('Failed to load LiDAR tiles:', err);
        }
      }

      // SSE Progress
      function subscribeToProgress(twinId) {
        if (activeSSE[twinId]) return;

        const es = new EventSource(`/api/twins/${twinId}/events`);
        activeSSE[twinId] = es;

        es.onmessage = (e) => {
          try {
            const data = JSON.parse(e.data);
            updateTwinCard(twinId, data);

            if (data.status === 'completed' || data.status === 'failed') {
              es.close();
              delete activeSSE[twinId];
              loadTwins();
            }
          } catch (err) {
            console.error('SSE parse error:', err);
          }
        };

        es.onerror = () => {
          es.close();
          delete activeSSE[twinId];
        };
      }

      function updateTwinCard(twinId, data) {
        const card = document.querySelector(`[data-twin-id="${twinId}"]`);
        if (!card) return;

        const statusEl = card.querySelector('.twin-status');
        const progressEl = card.querySelector('.progress-fill');
        const progressTextEl = card.querySelector('.progress-text');

        if (statusEl) {
          statusEl.className = `twin-status ${data.status}`;
          statusEl.textContent = data.status;
        }

        if (progressEl) {
          progressEl.style.width = `${data.progress_pct}%`;
        }

        if (progressTextEl) {
          progressTextEl.textContent = data.current_step
            ? `${data.progress_pct}% - ${data.current_step}`
            : `${data.progress_pct}%`;
        }
      }

      // Render Functions
      function renderTwins() {
        const grid = document.getElementById('twins-grid');
        let html = '';

        // Static Blyth twin (always show)
        html += `
          <div class="twin-card clickable completed" onclick="window.location.href='viewer.html'">
            <div class="twin-preview" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3d7ab0 100%);">
              <div class="twin-preview-placeholder" style="display:flex; flex-direction: column; gap: 5px;">
                <span style="font-size: 36px;">üèòÔ∏è</span>
                <span style="font-size: 12px; color: #87ceeb;">Click to Open</span>
              </div>
              <span class="twin-status completed">Live</span>
            </div>
            <div class="twin-info">
              <h3 class="twin-name">Blyth Digital Twin</h3>
              <p class="twin-location">Northumberland, England</p>
              <div class="twin-stats">
                <span class="twin-stat">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  </svg>
                  17,234 buildings
                </span>
                <span class="twin-stat">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                  </svg>
                  ~6 km¬≤
                </span>
              </div>
            </div>
          </div>
        `;

        // Dynamic twins from API
        for (const twin of twins) {
          const isClickable = twin.status === 'completed';
          const onclick = isClickable
            ? `window.location.href='viewer.html?twin=${twin.id}'`
            : '';

          html += `
            <div class="twin-card ${isClickable ? 'clickable' : ''} ${twin.status}"
                 data-twin-id="${twin.id}"
                 ${onclick ? `onclick="${onclick}"` : ''}>
              <div class="twin-preview">
                <div class="twin-preview-placeholder">üåç</div>
                <span class="twin-status ${twin.status}">${twin.status}</span>
              </div>
              <div class="twin-info">
                <h3 class="twin-name">${escapeHtml(twin.name)}</h3>
                <p class="twin-location">${escapeHtml(twin.location_name || formatCoords(twin.centre_lat, twin.centre_lon))}</p>
                <div class="twin-stats">
                  <span class="twin-stat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    </svg>
                    ${twin.building_count ? twin.building_count.toLocaleString() + ' buildings' : '‚Äî'}
                  </span>
                  <span class="twin-stat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2"/>
                    </svg>
                    ${(twin.side_length_m / 1000).toFixed(1)} km¬≤
                  </span>
                </div>
              </div>
              ${twin.status === 'running' || twin.status === 'pending' ? `
                <div class="twin-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${twin.progress_pct}%"></div>
                  </div>
                  <span class="progress-text">${twin.progress_pct}% ${twin.current_step ? '- ' + twin.current_step : ''}</span>
                </div>
              ` : ''}
              ${twin.status === 'awaiting_lidar' ? `
                <div class="twin-lidar-info" id="lidar-info-${twin.id}">
                  <div class="lidar-tiles">
                    <strong>LiDAR tiles needed</strong>
                    <div class="lidar-tile-list" id="lidar-tiles-${twin.id}">
                      Loading...
                    </div>
                  </div>
                  <div class="lidar-instructions">
                    Download DTM 1m tiles from the EA portal and place them in the twin's data directory.
                  </div>
                  <div class="lidar-actions">
                    <a href="https://environment.data.gov.uk/survey" target="_blank" class="btn btn-lidar btn-small">
                      Download from EA Portal
                    </a>
                    <button class="btn btn-primary btn-small" onclick="continueTwin('${twin.id}', event)">
                      I've uploaded tiles - Continue
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="skipLidar('${twin.id}', event)">
                      Skip LiDAR (flat terrain)
                    </button>
                  </div>
                </div>
              ` : ''}
              ${twin.status === 'failed' ? `
                <div class="twin-error">Error: ${escapeHtml(twin.error_message || 'Unknown error')}</div>
                <div class="twin-actions">
                  <button class="btn btn-primary btn-small" onclick="retryTwin('${twin.id}', event)">Retry</button>
                  <button class="btn btn-secondary btn-small" onclick="deleteTwin('${twin.id}', event)">Delete</button>
                </div>
              ` : ''}
              ${twin.status === 'completed' ? `
                <div class="twin-actions">
                  <button class="btn btn-secondary btn-small" onclick="regenerateTwin('${twin.id}', event)">Regenerate</button>
                  <button class="btn btn-secondary btn-small" onclick="deleteTwin('${twin.id}', event)">Delete</button>
                </div>
              ` : ''}
            </div>
          `;

          // Subscribe to running twins
          if (twin.status === 'running' || twin.status === 'pending') {
            subscribeToProgress(twin.id);
          }

          // Load LiDAR tile info for awaiting twins
          if (twin.status === 'awaiting_lidar') {
            setTimeout(() => loadLidarTiles(twin.id), 100);
          }
        }

        // Create new card
        html += `
          <div class="twin-card create-new" onclick="openCreateModal()">
            <div class="create-content">
              <div class="create-icon">+</div>
              <span class="create-text">Create New Twin</span>
              <span class="create-hint">Select an area on the map to generate a new digital twin</span>
            </div>
          </div>
        `;

        grid.innerHTML = html;
      }

      // Modal Functions
      function openCreateModal() {
        document.getElementById('createModal').classList.add('active');

        // Initialize map if not already done
        if (!map) {
          map = L.map('aoi-map').setView([54.5, -1.5], 6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);

          map.on('click', onMapClick);

          // Update rectangle on size change
          document.getElementById('twin-size').addEventListener('change', updateRectangle);
        }

        setTimeout(() => map.invalidateSize(), 100);
      }

      function closeCreateModal() {
        document.getElementById('createModal').classList.remove('active');
        // Reset form
        document.getElementById('twin-name').value = '';
        document.getElementById('twin-location').value = '';
        document.getElementById('twin-use-lidar').checked = true;
        selectedLat = null;
        selectedLon = null;
        if (marker) {
          map.removeLayer(marker);
          marker = null;
        }
        if (rectangle) {
          map.removeLayer(rectangle);
          rectangle = null;
        }
        document.getElementById('coords-display').textContent = 'Centre: Click map to select';
      }

      function onMapClick(e) {
        selectedLat = e.latlng.lat;
        selectedLon = e.latlng.lng;

        // Update marker
        if (marker) {
          marker.setLatLng(e.latlng);
        } else {
          marker = L.marker(e.latlng).addTo(map);
        }

        updateRectangle();

        document.getElementById('coords-display').textContent =
          `Centre: ${selectedLat.toFixed(5)}, ${selectedLon.toFixed(5)}`;
      }

      function updateRectangle() {
        if (!selectedLat || !selectedLon) return;

        const size = parseInt(document.getElementById('twin-size').value);
        const halfSizeKm = (size / 2) / 1000;

        // Approximate degrees (at UK latitudes)
        const latDelta = halfSizeKm / 111;
        const lonDelta = halfSizeKm / (111 * Math.cos(selectedLat * Math.PI / 180));

        const bounds = [
          [selectedLat - latDelta, selectedLon - lonDelta],
          [selectedLat + latDelta, selectedLon + lonDelta]
        ];

        if (rectangle) {
          rectangle.setBounds(bounds);
        } else {
          rectangle = L.rectangle(bounds, {
            color: '#2196F3',
            weight: 2,
            fillOpacity: 0.1
          }).addTo(map);
        }

        map.fitBounds(bounds, { padding: [50, 50] });
      }

      // Utilities
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function formatCoords(lat, lon) {
        return `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      }

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeCreateModal();
          closeRegenerateModal();
        }
      });

      document.getElementById('createModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          closeCreateModal();
        }
      });

      document.getElementById('regenerateModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          closeRegenerateModal();
        }
      });
    </script>
  </body>
</html>
